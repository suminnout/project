import os
import re
import json
import time
from contextlib import contextmanager
from typing import Dict, List, Any, Optional
from openai import OpenAI  # pip install openai>=1.40.0

# -------------------- ì•ˆì „ JSON íŒŒì„œ --------------------
def _parse_json_safely(text: str) -> Any:
    """ëª¨ë¸ì´ ì½”ë“œíœìŠ¤/ì„¤ëª… ë§ë¶™ì—¬ë„ ì²« ë²ˆì§¸ JSON ë°°ì—´ë§Œ ì•ˆì „ ì¶”ì¶œ."""
    cleaned = text.strip()
    # ì½”ë“œíœìŠ¤ ì œê±°
    cleaned = re.sub(r"^```(?:json)?\s*|\s*```$", "", cleaned, flags=re.IGNORECASE | re.MULTILINE)
    # ë°”ë¡œ íŒŒì‹± ì‹œë„
    try:
        return json.loads(cleaned)
    except json.JSONDecodeError:
        pass
    # ë³¸ë¬¸ ì¤‘ ì²« ë²ˆì§¸ JSON ë°°ì—´ë§Œ ì¶”ì¶œ
    m = re.search(r"\[\s*{.*?}\s*\]", cleaned, flags=re.DOTALL)
    if m:
        try:
            return json.loads(m.group(0))
        except Exception:
            pass
    return []


# -------------------- 1) ì‚¬ë¡€ ìˆ˜ì§‘: Perplexity(sonar) --------------------
def get_creative_solutions(user_question: str, model_name: str = "sonar") -> List[Dict[str, Any]]:
    """
    ì‚¬ìš©ìì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ì§ˆë¬¸ì„ ë°›ì•„,
    - ë‹¤êµ­ì–´ ê²€ìƒ‰
    - URL ìœ íš¨ì„± ì¤‘ì‹œ
    ë¡œ êµ¬ì„±ëœ ì‚¬ë¡€ JSON ë°°ì—´ì„ Perplexity(Chat Completions)ì—ì„œ ë°›ì•„ì˜µë‹ˆë‹¤.
    """
    try:
        api_key = "pplx-XXXXXXXXXXXXXXXX"
        client = OpenAI(api_key=api_key, base_url="https://api.perplexity.ai")

        prompt = f"""
# [ì—­í• ]
ë‹¹ì‹ ì€ ë‹¤ì–‘í•œ ì‚°ì—…ê³¼ ìŠ¤í¬ì¸  ë¦¬ê·¸ì˜ ì„±ê³µ ì‚¬ë¡€ë¥¼ ì‚¬ì‹¤ê³¼ ë°ì´í„°ì— ê¸°ë°˜í•´ íƒìƒ‰Â·ê²€ì¦í•˜ëŠ” ìµœê³  ì „ëµ ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤. ëª©í‘œëŠ” Kë¦¬ê·¸ ë§¥ë½ì— ì ìš© ê°€ëŠ¥í•œ **ë‹¤ì–‘í•œ ì¶œì²˜ì˜ â€˜ì‹¤ì¬ ì‚¬ë¡€â€™**ë¥¼ í™•ë³´í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì¶œë ¥ì€ **ìˆœìˆ˜ JSON ë°°ì—´**ë§Œ í—ˆìš©í•©ë‹ˆë‹¤(ì„¤ëª…Â·ì½”ë“œíœìŠ¤ ê¸ˆì§€).

# [ìˆ˜ì§‘ ì›ì¹™: ì¹´í…Œê³ ë¦¬ ì¿¼í„°(ì—„ê²©)]
- ì´ 4~5ê°œ ì‚¬ë¡€ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ë¥¼ **ê°€ëŠ¥í•œ í•œ ëª¨ë‘ ì¶©ì¡±**í•˜ì„¸ìš”.
  1) êµ­ë‚´-ì¶•êµ¬: ìµœëŒ€ 1ê°œ(=Kë¦¬ê·¸Â·ëŒ€í•œë¯¼êµ­ ì¶•êµ¬ ì‚¬ë¡€ëŠ” 0~1ê°œë¡œ ì œí•œ).
  2) êµ­ë‚´-íƒ€ì¢…ëª©: 0~1ê°œ(ì•¼êµ¬/ë†êµ¬/ë°°êµ¬/eìŠ¤í¬ì¸  í¬í•¨).
  3) íƒ€ì‚°ì—…(êµ­ë‚´): 0~1ê°œ(ìœ í†µ, ì—”í„°, ê´€ê´‘, ì§€ìì²´ ë“±).
  4) í•´ì™¸-ìŠ¤í¬ì¸ : **ìµœì†Œ 1ê°œ**.
  5) í•´ì™¸-íƒ€ì‚°ì—…: **ìµœì†Œ 1ê°œ**.
- Kë¦¬ê·¸ ë˜ëŠ” êµ­ë‚´ ì¶•êµ¬ ì‚¬ë¡€ê°€ 1ê°œë¥¼ ì´ˆê³¼í•˜ë©´ **ì´ˆê³¼ë¶„ì€ íê¸°**í•˜ê³  ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ë¡œ êµì²´í•©ë‹ˆë‹¤.
- ìœ íš¨ ì‚¬ë¡€ê°€ ë¶€ì¡±í•˜ë©´ **ìˆëŠ” ê²ƒë§Œ** ì±„íƒí•˜ê³ , ë¹ˆì¹¸ ì±„ìš°ê¸° ê¸ˆì§€.

# [ê²€ì¦ ê¸°ì¤€(í•„ìˆ˜)]
- **ì‹¤ì¬ì„±**: ê° ì‚¬ë¡€ëŠ” â‘ ì‚¬ë¡€/ìº í˜ì¸ëª…, â‘¡ì£¼ì²´(êµ¬ë‹¨/ê¸°ì—…/ê¸°ê´€ ë“±), â‘¢ì‹œì (ì—°Â·ì›”/ê¸°ê°„) ì¤‘ 2ê°€ì§€ ì´ìƒì´ ì›ë¬¸ì— ëª…ì‹œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
- **URL ìœ íš¨ì„±**: ê° ì‚¬ë¡€ëŠ” **í˜„ì¬ ì ‘ì† ê°€ëŠ¥í•œ ì •ì‹ https URL 1ê°œ ì´ìƒ**ì„ ë°˜ë“œì‹œ í¬í•¨(200/3xx ì˜ˆìƒ, ë¡œê·¸ì¸/ê²°ì œ/ì•± ì „ìš©/ì‚­ì œÂ·ë¹„ê³µê°œ/ë¬´í•œ ë¦¬ë‹¤ì´ë ‰íŠ¸/ì•µì»¤ ì „ìš©/ë‹¨ì¶• ì¶”ì ë§í¬ ë‹¨ë… ê¸ˆì§€).
- **ì‹ ë¢° ì¶œì²˜**: ê³µì‹ ë°œí‘œ/ê¸°ê´€Â·ë¦¬ê·¸/ì£¼ìš” ì–¸ë¡ /ê¸°ì—… ë³´ë„ìë£Œ/ì—°ì°¨ë³´ê³ ì„œ ë“± 1ì°¨Â·ê³µì‹ ë ¥ ë†’ì€ ì¶œì²˜ë¥¼ ìš°ì„ .
- **ì§ì ‘ ì—°ê´€ì„±**: â€˜í•µì‹¬_ì „ëµ_ë¶„ì„â€™ì€ ë°˜ë“œì‹œ URL ì›ë¬¸ì—ì„œ **ì§ì ‘ í™•ì¸ ê°€ëŠ¥í•œ ë¬¸ì¥/ì‚¬ì‹¤**ë§Œ ìš”ì•½(ì„ì˜ ì¶”ë¡  ê¸ˆì§€).

# [íƒìƒ‰ ë°©ë²•]
- êµ­ë‚´ í›„ë³´: í•œêµ­ì–´ í‚¤ì›Œë“œ.
- í•´ì™¸ í›„ë³´: **ì‚¬ìš©ì ì§ˆë¬¸ì˜ í•µì‹¬ ì˜ë„ë¥¼ ì˜ì–´ë¡œ ë²ˆì—­**í•˜ê³  ì˜ì–´ í‚¤ì›Œë“œë¡œ íƒìƒ‰.
- ë™ì¼ ìº í˜ì¸ì˜ ì¤‘ë³µ URLì€ **ê°€ì¥ ê³µì‹ ë ¥ ìˆê³  ìµœì‹ ** ë¬¸ì„œ 1ê°œë¡œ ì •ê·œí™”.

# [ì‚¬ìš©ì ì§ˆë¬¸]
"{user_question}"

# [ì¶œë ¥ í¬ë§·]
ë°˜ë“œì‹œ ì•„ë˜ì™€ ê°™ì€ 'ìˆœìˆ˜ JSON ë°°ì—´'ë§Œ ì¶œë ¥:
[
  {{
    "ì†”ë£¨ì…˜_ì œëª©": "ìº í˜ì¸/í”„ë¡œê·¸ë¨ëª…(ë˜ëŠ” ë¶„ëª…í•œ ì»¨ì…‰)",
    "ì°¸ê³ _ì‚°ì—…ë¶„ì•¼": "êµ­ë‚´-ì¶•êµ¬ | êµ­ë‚´-íƒ€ì¢…ëª© | í•´ì™¸-ìŠ¤í¬ì¸  | íƒ€ì‚°ì—…",
    "í•µì‹¬_ì „ëµ_ë¶„ì„": "ì›ë¬¸ì—ì„œ ì§ì ‘ í™•ì¸ ê°€ëŠ¥í•œ í•µì‹¬ ì „ëµÂ·ë©”ì»¤ë‹ˆì¦˜ ìš”ì•½(ì„ì˜ ì¶”ë¡  ê¸ˆì§€)",
    "Kë¦¬ê·¸_ì ìš©_ë°©ì•ˆ": "Kë¦¬ê·¸ ìƒí™©ì— ë§ì¶˜ ì‹¤í–‰ ì•„ì´ë””ì–´(ê°„ê²°)",
    "ê·¼ê±°_ì¶œì²˜": {{ "ë§¤ì²´": "ê³µì‹ ëª…ì¹­", "URL": "https://...", "ë°œí–‰ì¼": "YYYY-MM-DD" }},
    "ì°¸ê³ _ì„±ê³¼": ["ì›ë¬¸ì— ìˆëŠ” ì •ëŸ‰/ì •ì„± ì„±ê³¼ 1~2ê°œë§Œ. ì—†ìœ¼ë©´ []"]
  }}
]
""".strip()

        resp = client.chat.completions.create(
            model=model_name,                  # "sonar" / "sonar-medium-online" ë“±
            messages=[{"role": "user", "content": prompt}],
            temperature=0.1,
        )
        raw = resp.choices[0].message.content or "[]"
        data = _parse_json_safely(raw)

        # ë°©ì–´ì  ì²˜ë¦¬: ë¦¬ìŠ¤íŠ¸ê°€ ì•„ë‹ˆë©´ ë¹ˆ ë°°ì—´
        if not isinstance(data, list):
            return []

        # ìµœëŒ€ 5ê°œë¡œ ì œí•œ
        data = data[:5]
        return data

    except Exception as e:
        print(f"âŒ get_creative_solutions ì˜¤ë¥˜: {e}")
        return []


# -------------------- 2) ìµœì¢… í”„ë¡¬í”„íŠ¸ êµ¬ì„± --------------------
def build_final_prompt_case(
    user_query: str,
    solutions_json: str,
    history_summary: str = ""
) -> str:
    """
    Nk ì¸ìš©ë§Œ ì‚¬ìš©í•˜ëŠ” ë§ˆí¬ë‹¤ìš´ ìƒì„± ì§€ì¹¨ í”„ë¡¬í”„íŠ¸.
    solutions_json: ë°˜ë“œì‹œ json.dumps(list[dict], ensure_ascii=False) ê²°ê³¼ ë¬¸ìì—´.
    """
    return f"""
# [ì—­í• ]
ë‹¹ì‹ ì€ â€˜ì¼€ì´ìŠ¤ ìŠ¤í„°ë”” í¸ì§‘ìâ€™ì…ë‹ˆë‹¤. ì•„ë˜ [ì…ë ¥]ì˜ ì†”ë£¨ì…˜_JSONì„ ë°”íƒ•ìœ¼ë¡œ **ì¼€ì´ìŠ¤ë³„ ì¹´ë“œ** í˜•íƒœì˜ ë§ˆí¬ë‹¤ìš´ë§Œ ì¶œë ¥í•©ë‹ˆë‹¤. ì„¤ëª…/ë¶€ì—°/ì½”ë“œíœìŠ¤/í‘œ/JSON ê¸ˆì§€. ëª¨ë“  ë¬¸ì¥ì€ ë§ˆì¹¨í‘œë¡œ ëëƒ…ë‹ˆë‹¤.

# [ì´ì „ ëŒ€í™” ìš”ì•½]
{history_summary or "ì—†ìŒ"}
- ìœ„ ì´ì „ ëŒ€í™” ìš”ì•½ì„ ì¼ê´€ì„± ìœ ì§€ì— ì°¸ê³ í•˜ì—¬ ë‹µë³€í•˜ì„¸ìš”.

# [ì¶œë ¥ ëª©í‘œ]
- Kë¦¬ê·¸ ì‚¬ë¡€ì— ì¹˜ìš°ì¹˜ì§€ ì•Šê³ , êµ­ë‚´Â·í•´ì™¸Â·íƒ€ì‚°ì—…ì´ ì„ì¸ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
- ê° ì¼€ì´ìŠ¤ëŠ” 4ìš”ì†Œ(ì‚¬ë¡€/ëª©ì /ì„±ê³¼/í™œìš©ë°©ì•ˆ)ë¡œ ê°„ê²°í•˜ê²Œ ì •ë¦¬í•©ë‹ˆë‹¤.
- ê° ì¼€ì´ìŠ¤ **ì œëª© ì˜¤ë¥¸ìª½ì— ğŸ”— [Link](URL)** ë¥¼ ë„£ì–´ ì›ë¬¸ìœ¼ë¡œ ë°”ë¡œ ì´ë™í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
- ì¼€ì´ìŠ¤ì™€ ì¼€ì´ìŠ¤ ì‚¬ì´ëŠ” **êµ¬ë¶„ì„ (---)** ìœ¼ë¡œ ë‚˜ëˆ•ë‹ˆë‹¤.

# [URL ê·œì¹™]
- ì œëª©ì˜ ğŸ”— [Link](URL)ëŠ” **í˜„ì¬ ì ‘ì† ê°€ëŠ¥í•œ https(200/3xx)** ì—¬ì•¼ í•©ë‹ˆë‹¤.
- ë¡œê·¸ì¸/ê²°ì œ/ì•± ì „ìš©/ì‚­ì œÂ·ë¹„ê³µê°œ/ë¬´í•œ ë¦¬ë””ë ‰íŠ¸/ì•µì»¤(#) ì „ìš©/ë‹¨ì¶• ì¶”ì ë§í¬ ë‹¨ë…ì€ ê¸ˆì§€í•©ë‹ˆë‹¤.
- ìœ íš¨ URLì´ ì—†ê±°ë‚˜ ì ‘ì† ë¶ˆê°€í•˜ë©´ ì œëª© ì˜¤ë¥¸ìª½ì— ë§í¬ë¥¼ í‘œê¸°í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. **ì„ì˜ URL ìƒì„± ê¸ˆì§€.**

# [ì‘ì„± ê·œì¹™]
- ê° ì¼€ì´ìŠ¤ëŠ” ì•„ë˜ 4ê°œ í•­ëª©ì„ ëª¨ë‘ í¬í•¨í•©ë‹ˆë‹¤.
  - ì‚¬ë¡€: ì‚¬ë¡€/ìº í˜ì¸ëª… + ì£¼ì²´ + ì‹œì  ìš”ì•½. ê°€ëŠ¥í•˜ë©´ ê³ ìœ ëª… ì‚¬ìš©.
  - ëª©ì : ì›ë¬¸ ê·¼ê±°ë¡œ í™•ì¸ ê°€ëŠ¥í•œ ëª©í‘œÂ·ì˜ë„.
  - ì„±ê³¼: ì›ë¬¸ì— **ì§ì ‘ ê¸°ì¬ëœ ì„±ê³¼ë§Œ** 1~2ê°œ ë¶ˆë¦¿. ì—†ìœ¼ë©´ `ì„±ê³¼: ì—†ìŒ`.
  - í™œìš©ë°©ì•ˆ: Kë¦¬ê·¸ ì ìš© í¬ì¸íŠ¸ 1~2ë¬¸ì¥.
- ë¶ˆí•„ìš”í•œ ìˆ˜ì‚¬ë¥¼ ì œê±°í•˜ê³  **ê°„ê²°í•œ í•œêµ­ì–´**ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.

# [ì¶œë ¥ í˜•ì‹(ë§ˆí¬ë‹¤ìš´ë§Œ)]
## ì¼€ì´ìŠ¤ 1) [ì°¸ê³ _ì‚°ì—…ë¶„ì•¼] {{ì†”ë£¨ì…˜_ì œëª©}} Â· ğŸ”— [Link]({{ê·¼ê±°_ì¶œì²˜.URL}}) 
- ì‚¬ë¡€: {{ì£¼ì²´/ì‹œì /í•œì¤„ ì„¤ëª…}}.
- ëª©ì : {{ëª©í‘œ ìš”ì•½}}.
- ì„±ê³¼:
  - {{ì„±ê³¼ #1}}
  - {{ì„±ê³¼ #2}}
- í™œìš©ë°©ì•ˆ: {{Kë¦¬ê·¸ ì ìš© ì•„ì´ë””ì–´ 1~2ë¬¸ì¥}}.

---
## ì¼€ì´ìŠ¤ 2) [ì°¸ê³ _ì‚°ì—…ë¶„ì•¼] {{ì†”ë£¨ì…˜_ì œëª©}} Â· ğŸ”— [Link]({{ê·¼ê±°_ì¶œì²˜.URL}})
- ì‚¬ë¡€: ...
- ëª©ì : ...
- ì„±ê³¼:
  - ...
- í™œìš©ë°©ì•ˆ: ...

(í•„ìš” ì‹œ ì¼€ì´ìŠ¤ 5ê¹Œì§€ ë™ì¼ í˜•ì‹ìœ¼ë¡œ ì‘ì„±. URLì´ ì—†ê±°ë‚˜ ì ‘ì† ë¶ˆê°€í•˜ë©´ ì œëª© ì˜†ì— ë§í¬ í‘œê¸°í•˜ì§€ ì•ŠìŒ.)

# [ì…ë ¥]
[ì§ˆë¬¸]
{user_query}

[ì†”ë£¨ì…˜_JSON]
{solutions_json}
""".strip()


# -------------------- 3) ìµœì¢… ë§ˆí¬ë‹¤ìš´ ìƒì„±: Perplexity(sonar) --------------------
def generate_final_answer_text_case(
    final_prompt: str,
    *,
    model_name: str = "sonar",          # Perplexity ëª¨ë¸ëª…
    max_output_tokens: int = 2000,
    temperature: float = 0.4,
) -> str:
    """
    Perplexity(Chat Completions)ë¡œ ìµœì¢… ë§ˆí¬ë‹¤ìš´ ìƒì„±.
    ì¶œë ¥ì€ build_final_prompt_caseê°€ ê°•ì œí•œ 2ê°œ ì„¹ì…˜(âœ… ìµœì¢… ë‹µë³€ / ğŸ“° ì°¸ê³  ë‰´ìŠ¤)ë§Œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
    """
    try:
        api_key = "pplx-XXXXXXXXXXXXXX"
        client = OpenAI(api_key=api_key, base_url="https://api.perplexity.ai")

        resp = client.chat.completions.create(
            model=model_name,
            messages=[
                {
                    "role": "system",
                    "content": (
                            "ë‹¹ì‹ ì€ ìœ ëŠ¥í•œ ì¼€ì´ìŠ¤ ìŠ¤í„°ë”” í¸ì§‘ìì…ë‹ˆë‹¤. "
                            "ì˜¤ì§ ì§€ì‹œëœ 'ì¼€ì´ìŠ¤ ì¹´ë“œ' ë§ˆí¬ë‹¤ìš´ë§Œ ì¶œë ¥í•˜ê³ , "
                            "ê° ì¼€ì´ìŠ¤ ì œëª© ì˜†ì— ğŸ”— [Link](URL)ë¥¼ ë„£ìœ¼ë©°, "
                            "ì¼€ì´ìŠ¤ ì‚¬ì´ì— êµ¬ë¶„ì„  '---'ì„ ë„£ìœ¼ì„¸ìš”. "
                            "ë¬¸ì¥ ëì€ ë§ˆì¹¨í‘œë¡œ ëë‚´ê³ , ë¶ˆí•„ìš”í•œ í…ìŠ¤íŠ¸/ì½”ë“œë¸”ë¡/í‘œ/JSON/ì¶”ê°€ ì„¹ì…˜ì€ ê¸ˆì§€í•©ë‹ˆë‹¤."
                        ),
                },
                {"role": "user", "content": final_prompt},
            ],
            temperature=temperature,
            max_tokens=max_output_tokens,
        )
        return (resp.choices[0].message.content or "").strip()

    except Exception as e:
        print(f"âŒ generate_final_answer_text_case ì˜¤ë¥˜: {e}")
        return ""
